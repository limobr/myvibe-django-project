{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>myvibe - Connect Through Interests</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{% static 'assets/myvibe/style.css' %}">
</head>
<body data-theme="light">
    <!-- Main Header -->
    <header class="main-header">
        <div class="header-content">
            <button id="sidebarToggle" class="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <h1 class="logo">myvibe</h1>
            <div class="search-bar">
                <input type="text" placeholder="Search myvibe...">
                <i class="fas fa-search"></i>
            </div>
            <div class="header-right">
                <div class="mobile-search-icon">
                    <i class="fas fa-search"></i>
                </div>
                <div class="theme-switcher">
                    <i class="fas fa-moon"></i>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Message Container -->
        <div class="message-container">
            {% for message in messages %}
            <div class="message {{ message.tags }} animate-in">
                <div class="message-content">
                    {{ message }}
                    <div class="progress-bar">
                        <div class="progress"></div>
                    </div>
                    <button class="close-message">×</button>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="profile">
                {% if user.is_authenticated and user.userprofile.profile_picture %}
                <img src="{{ user.userprofile.profile_picture.url }}" class="profile-img" alt="Your profile">
                {% else %}
                <img src="{% static 'assets/myvibe/images/main-profile.jpg' %}" class="profile-img" alt="Default profile">
                {% endif %}
                <h3>{{ user.first_name }} {{ user.last_name }}</h3>
            </div>
            <nav class="menu">
                <div class="menu-item" data-tooltip="Profile">
                    <i class="fas fa-user"></i>
                    <span>Profile</span>
                </div>
                <div class="menu-item" data-tooltip="Events">
                    <i class="fas fa-calendar"></i>
                    <span>Events</span>
                </div>
                <div class="menu-item" data-tooltip="Explore">
                    <i class="fas fa-compass"></i>
                    <span>Explore</span>
                </div>
                <div class="menu-item" data-tooltip="Notifications">
                    <i class="fas fa-bell"></i>
                    <span>Notifications</span>
                    <span class="badge">3</span>
                </div>
                <div class="menu-item" data-tooltip="Create Post">
                    <i class="fas fa-plus"></i>
                    <span>Create Post</span>
                </div>
                <div class="menu-item" data-tooltip="Settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </div>
                <div class="menu-item" data-tooltip="Log Out">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Log Out</span>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            {% block content %}
            {% endblock %}
            <div class="modal" id="postModal">
                <div class="modal-content">
                    <button class="close-modal">×</button>
                    <div id="modalContent"></div>
                </div>
            </div>
        </main>

        <!-- Right Column -->
        <aside class="right-column">
            <h3>Upcoming Events</h3>
            <div class="event-card card">
                <img src="https://picsum.photos/320/120?random=9" alt="Event" class="event-image">
                <div class="event-details">
                    <h4>Tech Conference 2023</h4>
                    <div class="tags">
                        <span class="tag">#coding</span>
                        <span class="tag">#technology</span>
                    </div>
                </div>
            </div>
            <div class="ad-card card">
                <img src="https://picsum.photos/320/200?random=10" alt="Ad" class="ad-image">
                <p>Sponsored Content</p>
            </div>
        </aside>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <i class="fas fa-home active"></i>
        <i class="fas fa-calendar"><span class="badge">2</span></i>
        <i class="fas fa-bell"><span class="badge">3</span></i>
        <i class="fas fa-envelope"><span class="badge">1</span></i>
    </nav>

    <script>
        // Ensure script runs after DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing event listeners');

            // Message handling
            document.querySelectorAll('.message').forEach(message => {
                console.log('Found message element:', message);
                setTimeout(() => {
                    message.classList.remove('animate-in');
                    setTimeout(() => message.remove(), 300);
                }, 5000);

                message.querySelector('.close-message').addEventListener('click', () => {
                    console.log('Close message clicked');
                    message.classList.remove('animate-in');
                    setTimeout(() => message.remove(), 300);
                });

                message.querySelector('.progress-bar').addEventListener('click', () => {
                    console.log('Progress bar clicked');
                    message.classList.remove('animate-in');
                    setTimeout(() => message.remove(), 300);
                });
            });

            // Sidebar and Search Toggle
            const sidebarToggle = document.getElementById('sidebarToggle');
            const container = document.querySelector('.container');
            const sidebar = document.querySelector('.sidebar');
            const mobileSearchIcon = document.querySelector('.mobile-search-icon i');
            const searchBar = document.querySelector('.search-bar');

            if (!sidebarToggle) console.error('Sidebar toggle button not found');
            if (!sidebar) console.error('Sidebar not found');
            if (!mobileSearchIcon) console.error('Mobile search icon not found');
            if (!searchBar) console.error('Search bar not found');

            // Sidebar Toggle Handler
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Sidebar toggle clicked, screen width:', window.innerWidth);
                    if (window.innerWidth > 1024) {
                        console.log('Toggling sidebar-collapsed for large screen');
                        container.classList.toggle('sidebar-collapsed');
                        sidebar.classList.toggle('sidebar-collapsed');
                    } else if (window.innerWidth > 768) {
                        console.log('Toggling sidebar-expanded for semi screen');
                        container.classList.toggle('sidebar-expanded');
                        sidebar.classList.toggle('sidebar-collapsed');
                    } else {
                        console.log('Toggling sidebar-active for small screen');
                        sidebar.classList.toggle('sidebar-active');
                    }
                });
            }

            // Mobile Search Toggle Handler
            if (mobileSearchIcon) {
                mobileSearchIcon.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Mobile search icon clicked');
                    searchBar.classList.toggle('active');
                });
            }

            // Outside Click Handler with Debounce
            let justToggled = false;
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && !justToggled) {
                    if (sidebar && !sidebar.contains(e.target) && e.target !== sidebarToggle && !e.target.closest('#sidebarToggle')) {
                        console.log('Outside click, closing sidebar');
                        sidebar.classList.remove('sidebar-active');
                    }
                    if (searchBar && !searchBar.contains(e.target) && e.target !== mobileSearchIcon && !e.target.closest('.mobile-search-icon')) {
                        console.log('Outside click, closing search bar');
                        searchBar.classList.remove('active');
                    }
                }
                justToggled = false;
            });

            // Prevent immediate outside click after toggle
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', () => {
                    justToggled = true;
                    setTimeout(() => { justToggled = false; }, 100);
                });
            }
            if (mobileSearchIcon) {
                mobileSearchIcon.addEventListener('click', () => {
                    justToggled = true;
                    setTimeout(() => { justToggled = false; }, 100);
                });
            }

            // Resize Handler
            window.addEventListener('resize', () => {
                console.log('Window resized, width:', window.innerWidth);
                if (window.innerWidth > 1024) {
                    container.classList.remove('sidebar-expanded');
                    sidebar.classList.remove('sidebar-active', 'sidebar-collapsed');
                } else if (window.innerWidth > 768) {
                    container.classList.remove('sidebar-collapsed');
                    sidebar.classList.remove('sidebar-active');
                    container.classList.add('sidebar-expanded');
                    sidebar.classList.remove('sidebar-collapsed');
                } else {
                    container.classList.remove('sidebar-collapsed', 'sidebar-expanded');
                    sidebar.classList.remove('sidebar-collapsed');
                }
                searchBar.classList.remove('active');
            });
        });
    </script>
    <script src="{% static 'assets/myvibe/script.js' %}"></script>
</body>
</html>