{% load static %}
<div class="post-details">
  <p>{{ post.description }}</p>
  <div class="media-files">
    {% for media in post.media_files.all %}
      <div class="media-item">
        {% if media.media_type == 'image' %}
          <img src="{{ media.file.url }}" alt="" class="media-image" onclick="openMediaDialog('{{ media.file.url }}', 'image')" />
          <div class="media-buttons">
            <span class="like-btn"><i class="fa-regular fa-heart"></i></span>
            <span class="comment-btn"><i class="fa-regular fa-comment"></i></span>
            <span class="bookmark-btn"><i class="fa-regular fa-bookmark"></i></span>
            <span class="share-btn"><i class="fa-regular fa-paper-plane"></i></span>
          </div>
        {% elif media.media_type == 'video' %}
          <video src="{{ media.file.url }}" controls class="media-video" onclick="openMediaDialog('{{ media.file.url }}', 'video')"></video>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</div>

<!-- Fullscreen media dialog -->
<dialog id="mediaDialog" class="media-dialog">
  <div id="mediaContent"></div>
  <button class="close-btn" onclick="closeMediaDialog()">Close</button>
</dialog>

<div id="commentsSection">
  {% for comment in post.comments.all %}
    <div class="comment">
      <p>{{ comment.text }}</p>
      <small>By {{ comment.user.get_full_name|default:comment.user.username }} on {{ comment.created_at|date:"F j, Y, g:i a" }}</small>
    </div>
  {% endfor %}
</div>
<form id="commentForm">
  <input type="text" id="commentInput" placeholder="Add a comment..." style="width: 80%; padding: 5px;">
  <button type="submit" style="padding: 5px 10px;">Post</button>
  <div id="commentLoader" class="loader" style="display: none; margin-top: 10px;"></div>
</form>

<!-- Internal CSS -->
<style>
  /* Add styles for the fullscreen dialog */
  .media-dialog {
    width: 100%;
    height: 100%;
    border: none;
    padding: 0;
    overflow: hidden;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1000;
    background-color: rgba(0, 0, 0, 0.8);
  }

  .media-dialog::backdrop {
    background-color: rgba(0, 0, 0, 0.8);
  }

  .media-dialog img, .media-dialog video {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .close-btn {
    position: absolute;
    top: 10px;
    right: 20px;
    background-color: #fff;
    border: none;
    padding: 10px;
    cursor: pointer;
    font-size: 1rem;
    border-radius: 5px;
  }

  .close-btn:hover {
    background-color: #f3f3f3;
  }

  .post-details {
    margin-bottom: 15px;
  }

  .post-details p {
    font-size: 1rem;
    color: #333;
    line-height: 1.5;
  }

  .media-files {
    margin-top: 10px;
  }

  .media-item {
    margin-bottom: 20px;
  }

  .media-image, .media-video {
    max-width: 100%;
    cursor: pointer;
  }

  .media-buttons {
    display: flex;
    justify-content: space-around;
    margin-top: 10px;
  }

  .media-buttons span {
    cursor: pointer;
    font-size: 1.2rem;
    color: #555;
  }

  .media-buttons span:hover {
    color: #3498db;
  }

  /* Comments section */
  #commentsSection {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 15px;
  }

  .comment {
    margin-bottom: 10px;
    padding: 10px;
    background-color: #f9f9f9;
    border-radius: 5px;
  }

  .comment p {
    margin: 0 0 5px 0;
    font-size: 0.95rem;
    color: #555;
  }

  .comment small {
    font-size: 0.85rem;
    color: #888;
  }

  #commentForm {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  #commentInput {
    border: 1px solid #ddd;
    border-radius: 4px;
  }

  #commentForm button {
    background-color: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  #commentForm button:hover {
    background-color: #2980b9;
  }

  .loader {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    animation: spin 1s linear infinite;
    margin-left: auto;
    margin-right: auto;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>

<!-- Internal JavaScript -->
<script>
  var csrfToken = '{{ csrf_token }}'; // Ensure this is passed correctly

  function openMediaDialog(url, type) {
    var mediaDialog = document.getElementById('mediaDialog');
    var mediaContent = document.getElementById('mediaContent');
    
    if (type === 'image') {
      mediaContent.innerHTML = '<img src="' + url + '" alt="Full screen image">';
    } else if (type === 'video') {
      mediaContent.innerHTML = '<video src="' + url + '" controls autoplay></video>';
    }
    
    mediaDialog.showModal();
  }

  function closeMediaDialog() {
    var mediaDialog = document.getElementById('mediaDialog');
    mediaDialog.close();
  }

  document.getElementById('commentForm').addEventListener('submit', function(e) {
    e.preventDefault();

    var commentInput = document.getElementById('commentInput');
    var commentLoader = document.getElementById('commentLoader');
    var commentsSection = document.getElementById('commentsSection');
    var commentText = commentInput.value.trim();

    if (!commentText) return;

    commentLoader.style.display = 'block'; // Show loader

    fetch('/add-comment/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({
        post_id: {{ post.id }},
        text: commentText
      })
    })
      .then(response => {
        if (!response.ok) throw new Error('Failed to post comment');
        return response.json();
      })
      .then(data => {
        commentLoader.style.display = 'none'; // Hide loader
        if (data.success) {
          var newComment = document.createElement('div');
          newComment.className = 'comment';
          newComment.innerHTML = `
            <p>${data.comment.text}</p>
            <small>By ${data.comment.user} on ${data.comment.created_at}</small>
          `;
          commentsSection.appendChild(newComment);
          commentInput.value = ''; // Clear input
        } else {
          alert('Failed to add comment: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        commentLoader.style.display = 'none';
        alert('Error posting comment: ' + error.message);
      });
  });
</script>
